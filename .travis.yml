git:
  depth: 3
env:
  global:
  - AWS_DEFAULT_REGION: us-west-1
  - S3_PARAMS: '"--acl public-read --cache-control \"public,must-revalidate,proxy-revalidate,max-age=0\""'
  - secure: WY8ZM+p3HyJWQ8nbfcjBiExFKhZdkHQyvVMJGNsE0aj8X/8fbaUufjA5Tp+me9ysb81lFL6xlkAhIxoEMw6L3N232jgDeoW1gYLaAxp2rSogsDJ0gvHFBngLB5mHEyb7kqXJHxVGI4RR2knwIqXANxwCGrpQw9eHPO04kM8hr4bxGy1Y86/3jXOwXmrln2U+PMJkLu1m1Afz0t5784qBTdlkL9PlpYEsFYbYjHYhuxDQ6T4nreZLXn5PEmNwKW2f6TQdlJQiuatnzbLYi0MJ4RhP6D8jrNpQCPUp7b8gqsvRvqcotSRzvuGyrtBUEurxZSJZu/iDg+j6D5U8rFFOqUhGHEngajIzf1O2NKisuPUXnlE51cx6Vx86JOgkTkriHmnuCVGbRuIv62Mye00/fajL8hORqNH3guEzDj2el2bpv1g7tn0J3kRuhWGea8WRA9Zjwt1zOrfuY4F++IQDSZg+AoMCL7iLWDXpT0iw2Zr+MlQzSnMd9GREmJB6DKb0EayQqcPIfFYITxZ4gGU7BfoTV6DlPGF+8X8XBcu1NN7gqteYwyHycF/2Fy5MmAkAmY7qlr2L5i5xuB48cjaUnMDDDQiOXGvEIhL/jPxuIk+Ovbdaj1Ejh/4zMzqDT1XwLvC1Q1ulnEH401VZZYwUSezAoGGjRbhO6M7puU4sUFU=
matrix:
  include:
  - name: Linux x64
    dist: xenial
    language: cpp
    compiler: gcc
    addons:
      apt:
        packages:
        - gcc-5
        - g++-5
        - libgl1-mesa-dev
        - x11proto-core-dev
        - libx11-dev
    before_script:
    - git clone --depth 1 https://github.com/LWJGL-CI/bx.git ../bx
    - git clone --depth 1 https://github.com/LWJGL-CI/bimg.git ../bimg
    before_install:
    - pip install --user awscli
    - export PATH=$PATH:$HOME/.local/bin
    - sudo ln -s /usr/lib/x86_64-linux-gnu/mesa/libGL.so.1 /usr/lib/libGL.so
    script:
    - "../bx/tools/bin/linux/genie --with-shared-lib --with-tools --gcc=linux-gcc
      gmake"
    - make -R -C .build/projects/gmake-linux config=release64 CXX="g++-5" CC="gcc-5"
      CFLAGS="-U_FORTIFY_SOURCE -D_FORTIFY_SOURCE=0" LDFLAGS=-Wl,--wrap,memcpy bgfx-shared-lib
    - make -R -C .build/projects/gmake-linux config=release64 CXX="g++-5" CC="gcc-5"
      geometryc
    - make -R -C .build/projects/gmake-linux config=release64 CXX="g++-5" CC="gcc-5"
      texturec
    - make -R -C .build/projects/gmake-linux config=release64 CXX="g++-5" CC="gcc-5"
      texturev
    - make -R -C .build/projects/gmake-linux config=release64 CXX="g++-5" CC="gcc-5"
      shaderc
    - strip .build/linux64_gcc/bin/libbgfx-shared-libRelease.so
    - git log --first-parent --pretty=format:%H HEAD~2..HEAD~1 > libbgfx.so.git
    - aws s3 cp .build/linux64_gcc/bin/libbgfx-shared-libRelease.so s3://lwjgl-mips64/nightly/linux/x64/libbgfx.so
      $S3_PARAMS
    - aws s3 cp libbgfx.so.git s3://lwjgl-mips64/nightly/linux/x64/ $S3_PARAMS
    - aws s3 cp .build/linux64_gcc/bin/geometrycRelease s3://lwjgl-mips64/nightly/linux/x64/bgfx-tools/geometryc
      $S3_PARAMS
    - aws s3 cp .build/linux64_gcc/bin/texturecRelease s3://lwjgl-mips64/nightly/linux/x64/bgfx-tools/texturec
      $S3_PARAMS
    - aws s3 cp .build/linux64_gcc/bin/texturevRelease s3://lwjgl-mips64/nightly/linux/x64/bgfx-tools/texturev
      $S3_PARAMS
    - aws s3 cp .build/linux64_gcc/bin/shadercRelease s3://lwjgl-mips64/nightly/linux/x64/bgfx-tools/shaderc
      $S3_PARAMS
  - name: Linux arm32
    dist: xenial
    language: c
    compiler: gcc
    addons:
      apt:
        packages:
        - gcc-5-arm-linux-gnueabihf
        - g++-5-arm-linux-gnueabihf
        - libc6-dev-armhf-cross
    before_script:
    - git clone --depth 1 https://github.com/LWJGL-CI/bx.git ../bx
    - git clone --depth 1 https://github.com/LWJGL-CI/bimg.git ../bimg
    before_install:
    - pip install --user awscli
    - export PATH=$PATH:$HOME/.local/bin
    - sudo sed -i 's/deb http/deb [arch=amd64,i386] http/' /etc/apt/sources.list
    - sudo grep "ubuntu.com/ubuntu" /etc/apt/sources.list | sudo tee /etc/apt/sources.list.d/ports.list
    - sudo sed -i 's/amd64,i386/armhf,arm64/' /etc/apt/sources.list.d/ports.list
    - sudo sed -i 's#http://.*/ubuntu#http://ports.ubuntu.com/ubuntu-ports#' /etc/apt/sources.list.d/ports.list
    - sudo dpkg --add-architecture armhf
    - sudo apt-get update || true
    - sudo apt-get -yq --no-install-suggests --no-install-recommends install libgl1-mesa-dev:armhf
      x11proto-core-dev:armhf libx11-dev:armhf -o Dpkg::Options::="--force-overwrite"
    - sudo ln -s /usr/lib/arm-linux-gnueabihf/mesa/libGL.so.1 /usr/lib/libGL.so
    script:
    - sed -i 's/strip -s/arm-linux-gnueabihf-strip/' ../bx/scripts/toolchain.lua
    - "../bx/tools/bin/linux/genie --with-shared-lib --gcc=linux-arm-gcc gmake"
    - make -R -C .build/projects/gmake-linux-arm-gcc config=release CXX="arm-linux-gnueabihf-g++-5"
      CC="arm-linux-gnueabihf-gcc-5" CFLAGS="-U_FORTIFY_SOURCE -D_FORTIFY_SOURCE=0"
      bgfx-shared-lib
    - arm-linux-gnueabihf-strip .build/linux32_arm_gcc/bin/libbgfx-shared-libRelease.so
    - git log --first-parent --pretty=format:%H HEAD~2..HEAD~1 > libbgfx.so.git
    - aws s3 cp .build/linux32_arm_gcc/bin/libbgfx-shared-libRelease.so s3://lwjgl-mips64/nightly/linux/arm32/libbgfx.so
      $S3_PARAMS
    - aws s3 cp libbgfx.so.git s3://lwjgl-mips64/nightly/linux/arm32/ $S3_PARAMS
  - name: Linux arm64
    dist: xenial
    language: c
    compiler: gcc
    addons:
      apt:
        packages:
        - gcc-5-aarch64-linux-gnu
        - g++-5-aarch64-linux-gnu
        - libc6-dev-arm64-cross
    before_script:
    - git clone --depth 1 https://github.com/LWJGL-CI/bx.git ../bx
    - git clone --depth 1 https://github.com/LWJGL-CI/bimg.git ../bimg
    before_install:
    - pip install --user awscli
    - export PATH=$PATH:$HOME/.local/bin
    - sudo sed -i 's/deb http/deb [arch=amd64,i386] http/' /etc/apt/sources.list
    - sudo grep "ubuntu.com/ubuntu" /etc/apt/sources.list | sudo tee /etc/apt/sources.list.d/ports.list
    - sudo sed -i 's/amd64,i386/arm64,arm64/' /etc/apt/sources.list.d/ports.list
    - sudo sed -i 's#http://.*/ubuntu#http://ports.ubuntu.com/ubuntu-ports#' /etc/apt/sources.list.d/ports.list
    - sudo dpkg --add-architecture arm64
    - sudo apt-get update || true
    - sudo apt-get -yq --no-install-suggests --no-install-recommends install libgl1-mesa-dev:arm64
      x11proto-core-dev:arm64 libx11-dev:arm64 -o Dpkg::Options::="--force-overwrite"
    - sudo ln -s /usr/lib/aarch64-linux-gnu/mesa/libGL.so.1 /usr/lib/libGL.so
    script:
    - sed -i 's/strip -s/aarch64-linux-gnu-strip/' ../bx/scripts/toolchain.lua
    - "../bx/tools/bin/linux/genie --with-shared-lib --gcc=linux-arm-gcc gmake"
    - sed -i 's/ -m64//' .build/projects/gmake-linux-arm-gcc/bgfx.make
    - sed -i 's/ -m64//' .build/projects/gmake-linux-arm-gcc/bgfx-shared-lib.make
    - sed -i 's/ -m64//' .build/projects/gmake-linux-arm-gcc/bimg.make
    - sed -i 's/ -m64//' .build/projects/gmake-linux-arm-gcc/bimg_decode.make
    - sed -i 's/ -m64//' .build/projects/gmake-linux-arm-gcc/bx.make
    - sed -i 's/linux32/linux64/g' .build/projects/gmake-linux-arm-gcc/bgfx.make
    - sed -i 's/linux32/linux64/g' .build/projects/gmake-linux-arm-gcc/bgfx-shared-lib.make
    - sed -i 's/linux32/linux64/g' .build/projects/gmake-linux-arm-gcc/bimg.make
    - sed -i 's/linux32/linux64/g' .build/projects/gmake-linux-arm-gcc/bimg_decode.make
    - sed -i 's/linux32/linux64/g' .build/projects/gmake-linux-arm-gcc/bx.make
    - make -R -C .build/projects/gmake-linux-arm-gcc config=release64 CXX="aarch64-linux-gnu-g++-5"
      CC="aarch64-linux-gnu-gcc-5" CFLAGS="-U_FORTIFY_SOURCE -D_FORTIFY_SOURCE=0"
      bgfx-shared-lib
    - aarch64-linux-gnu-strip .build/linux64_arm_gcc/bin/libbgfx-shared-libRelease.so
    - git log --first-parent --pretty=format:%H HEAD~2..HEAD~1 > libbgfx.so.git
    - aws s3 cp .build/linux64_arm_gcc/bin/libbgfx-shared-libRelease.so s3://lwjgl-mips64/nightly/linux/arm64/libbgfx.so
      $S3_PARAMS
    - aws s3 cp libbgfx.so.git s3://lwjgl-mips64/nightly/linux/arm64/ $S3_PARAMS
  - name: Linux mips64
    dist: xenial
    language: c
    compiler: gcc
    addons:
      apt:
        packages:
        - gcc-5-mips64el-linux-gnuabi64
        - g++-5-mips64el-linux-gnuabi64
        - libc6-dev-mips64el-cross
    before_script:
    - git clone --depth 1 https://github.com/LWJGL-CI/bx.git ../bx
    - git clone --depth 1 https://github.com/LWJGL-CI/bimg.git ../bimg
    before_install:
    - pip install --user awscli
    - export PATH=$PATH:$HOME/.local/bin
    - sudo rm -rf /etc/apt/sources.list
    - sudo sh -c "echo 'deb http://deb.debian.org/debian stretch main' >> /etc/apt/sources.list"
    - sudo dpkg --add-architecture mips64el
    - sudo apt-get update || true
    - sudo apt-get -yq -f --allow-unauthenticated --no-install-suggests --no-install-recommends
      install libgl1-mesa-dev:mips64el x11proto-core-dev:mips64el libx11-dev:mips64el
      mesa-common-dev:mips64el libgl1-mesa-glx:mips64el libdrm-dev:mips64el libdrm2:mips64el
      libdrm-radeon1:mips64el libdrm-nouveau2:mips64el libdrm-amdgpu1:mips64el libglapi-mesa:mips64el
      -o Dpkg::Options::="--force-overwrite"
    - sudo ln -s /usr/lib/mips64el-linux-gnuabi64/mesa/libGL.so.1 /usr/lib/libGL.so
    script:
    - sed -i 's/strip -s/mips64el-linux-gnuabi64-strip/' ../bx/scripts/toolchain.lua
    - "../bx/tools/bin/linux/genie --with-shared-lib --gcc=linux-mips-gcc gmake"
    - sed -i 's/ -m64//' .build/projects/gmake-linux-mips-gcc/bgfx.make
    - sed -i 's/ -m64//' .build/projects/gmake-linux-mips-gcc/bgfx-shared-lib.make
    - sed -i 's/ -m64//' .build/projects/gmake-linux-mips-gcc/bimg.make
    - sed -i 's/ -m64//' .build/projects/gmake-linux-mips-gcc/bimg_decode.make
    - sed -i 's/ -m64//' .build/projects/gmake-linux-mips-gcc/bx.make
    - sed -i 's/linux32/linux64/g' .build/projects/gmake-linux-mips-gcc/bgfx.make
    - sed -i 's/linux32/linux64/g' .build/projects/gmake-linux-mips-gcc/bgfx-shared-lib.make
    - sed -i 's/linux32/linux64/g' .build/projects/gmake-linux-mips-gcc/bimg.make
    - sed -i 's/linux32/linux64/g' .build/projects/gmake-linux-mips-gcc/bimg_decode.make
    - sed -i 's/linux32/linux64/g' .build/projects/gmake-linux-mips-gcc/bx.make
    - make -R -C .build/projects/gmake-linux-mips-gcc config=release64 CXX="mips64el-linux-gnuabi64-g++-5"
      CC="mips64el-linux-gnuabi64-gcc-5" CFLAGS="-U_FORTIFY_SOURCE -D_FORTIFY_SOURCE=0"
      bgfx-shared-lib
    - mips64el-linux-gnuabi64-strip .build/linux64_mips_gcc/bin/libbgfx-shared-libRelease.so
    - git log --first-parent --pretty=format:%H HEAD~2..HEAD~1 > libbgfx.so.git
    - aws s3 cp .build/linux64_mips_gcc/bin/libbgfx-shared-libRelease.so s3://lwjgl-mips64/nightly/linux/mips64/libbgfx.so
      $S3_PARAMS
    - aws s3 cp libbgfx.so.git s3://lwjgl-mips64/nightly/linux/mips64/ $S3_PARAMS
  - name: macOS
    language: objective-c
    compiler: clang
    osx_image: xcode11.3
    before_script:
    - git clone --depth 1 https://github.com/LWJGL-CI/bx.git ../bx
    - git clone --depth 1 https://github.com/LWJGL-CI/bimg.git ../bimg
    before_install:
    - brew update
    install:
    - brew install awscli
    script:
    - "../bx/tools/bin/darwin/genie --with-shared-lib --with-tools --with-macos=10.9
      --gcc=osx gmake"
    - make -C .build/projects/gmake-osx config=release64 CFLAGS="-D BGFX_CONFIG_RENDERER_METAL=1
      -D BGFX_CONFIG_RENDERER_OPENGL=1" bgfx-shared-lib
    - make -C .build/projects/gmake-osx config=release64 geometryc
    - make -C .build/projects/gmake-osx config=release64 texturec
    - make -C .build/projects/gmake-osx config=release64 texturev
    - make -C .build/projects/gmake-osx config=release64 shaderc
    - strip -u -r .build/osx64_clang/bin/libbgfx-shared-libRelease.dylib
    - git log --first-parent --pretty=format:%H HEAD~2..HEAD~1 > libbgfx.dylib.git
    - aws s3 cp .build/osx64_clang/bin/libbgfx-shared-libRelease.dylib s3://lwjgl-mips64/nightly/macosx/x64/libbgfx.dylib
      $S3_PARAMS
    - aws s3 cp libbgfx.dylib.git s3://lwjgl-mips64/nightly/macosx/x64/ --acl public-read
      --cache-control "public, must-revalidate, proxy-revalidate, max-age=0"
    - aws s3 cp .build/osx64_clang/bin/geometrycRelease s3://lwjgl-mips64/nightly/macosx/x64/bgfx-tools/geometryc
      $S3_PARAMS
    - aws s3 cp .build/osx64_clang/bin/texturecRelease s3://lwjgl-mips64/nightly/macosx/x64/bgfx-tools/texturec
      $S3_PARAMS
    - aws s3 cp .build/osx64_clang/bin/texturevRelease s3://lwjgl-mips64/nightly/macosx/x64/bgfx-tools/texturev
      $S3_PARAMS
    - aws s3 cp .build/osx64_clang/bin/shadercRelease s3://lwjgl-mips64/nightly/macosx/x64/bgfx-tools/shaderc
      $S3_PARAMS
